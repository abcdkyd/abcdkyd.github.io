<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />

    

    

    <title>PostgreSQL pl/pgsql 编写存储过程 | Jxie的个人博客</title>
    <meta name="author" content="Jxie" />
    <meta name="version" content="1.0.0" />
    <meta name="keywords" content="" />
    <meta name="description" content="基本结构123456789create or replace function somefunc() returns varchar as $$declare   name varchar := &#39;wangzhen&#39;;begin   return name;end   $$ language plpgsql;$$作用函数代码在function中实际上为一个字符串，代码1和代码2等价，但代码中字符串的单引号需要写两个进行转义。12345678910-- 代码1create or ..." />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />

    
    <link rel="alternate" href="/atom.xml" title="Jxie的个人博客" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/favicon.ico">
    

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <main class="app">
        <header class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">Jxie的个人博客</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item" href="/">
                <span class="nav-text">首页</span>
            </a>
        
            <a class="nav-item" href="/categories">
                <span class="nav-text">分类</span>
            </a>
        
            <a class="nav-item" href="/tags">
                <span class="nav-text">标签</span>
            </a>
        
            <a class="nav-item" href="/archives">
                <span class="nav-text">归档</span>
            </a>
        
            <a class="nav-item" href="/atom.xml">
                <span class="nav-text">订阅</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="https://abcdkyd.github.io"></form>

        
        
        
        

        
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#基本结构"><span class="toc-number">1.</span> <span class="toc-text">基本结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#作用"><span class="toc-number">2.</span> <span class="toc-text">$$作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#代码块"><span class="toc-number">3.</span> <span class="toc-text">代码块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#命名参数"><span class="toc-number">4.</span> <span class="toc-text">命名参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#执行sql"><span class="toc-number">5.</span> <span class="toc-text">执行sql</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#返回结果"><span class="toc-number">6.</span> <span class="toc-text">返回结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#循环判断"><span class="toc-number">7.</span> <span class="toc-text">循环判断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考资料"><span class="toc-number">8.</span> <span class="toc-text">参考资料</span></a></li></ol>
        
    </div>
</aside>

</header>

        <div id="content" class="content"><article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            PostgreSQL pl/pgsql 编写存储过程
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://abcdkyd.github.io/2018/06/15/postgres编写存储过程/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2018-06-14T16:49:43.000Z" itemprop="datePublished">2018-06-15</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/PostgreSQL/">PostgreSQL</a>, <a class="article-tag-link" href="/tags/存储过程/">存储过程</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h3 id="基本结构"><a class="header-anchor" href="#基本结构"></a>基本结构</h3>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc() </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">varchar</span> <span class="keyword">as</span> </span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">   <span class="keyword">name</span> <span class="built_in">varchar</span> := <span class="string">'wangzhen'</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">name</span>;</span><br><span class="line"><span class="keyword">end</span>   </span><br><span class="line">$$ <span class="keyword">language</span> plpgsql;</span><br></pre></td></tr></table></figure>
<h3 id="作用"><a class="header-anchor" href="#作用"></a>$$作用</h3>
<ul>
<li>
<p>函数代码在function中实际上为一个字符串，代码1和代码2等价，但代码中字符串的单引号需要写两个进行转义。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 代码1</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc() </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">varchar</span> <span class="keyword">as</span> </span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">   <span class="keyword">name</span> <span class="built_in">varchar</span> := <span class="string">'wangzhen'</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">name</span>;</span><br><span class="line"><span class="keyword">end</span>   </span><br><span class="line">$$ <span class="keyword">language</span> plpgsql;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--代码2</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc() </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">varchar</span> <span class="keyword">as</span> </span><br><span class="line"><span class="string">'</span></span><br><span class="line"><span class="string">declare</span></span><br><span class="line"><span class="string">   name varchar := ''wangzhen'';</span></span><br><span class="line"><span class="string">begin</span></span><br><span class="line"><span class="string">   return name;</span></span><br><span class="line"><span class="string">end   </span></span><br><span class="line"><span class="string">'</span> <span class="keyword">language</span> plpgsql;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>“美元符引用”书写字符串常量，使单引号、反斜线、$符等按照字面值进行解释，不需要写两个或在4个或着更多进行转义，代码3和代码4等价。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--代码3</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc() </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">varchar</span> <span class="keyword">as</span> </span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">   <span class="keyword">name</span> <span class="built_in">varchar</span> := <span class="string">'wangzhen''blog'</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">name</span>;</span><br><span class="line"><span class="keyword">end</span>   </span><br><span class="line">$$ <span class="keyword">language</span> plpgsql;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--代码4</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc() </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">varchar</span> <span class="keyword">as</span> </span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">   <span class="keyword">name</span> <span class="built_in">varchar</span> := $tag$wangzhen<span class="string">'blog$tag$;</span></span><br><span class="line"><span class="string">begin</span></span><br><span class="line"><span class="string">   return name;</span></span><br><span class="line"><span class="string">end   </span></span><br><span class="line"><span class="string">$$ language plpgsql;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>$中间可以包含可选的标签，但是标签要成对出现，且大小写敏感。代码5和代码6和代码7等价。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--代码5</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc() </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">varchar</span> <span class="keyword">as</span> </span><br><span class="line">$<span class="keyword">body</span>$</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">   <span class="keyword">name</span> <span class="built_in">varchar</span> := $tag$wangzhen<span class="string">'blog$tag$;</span></span><br><span class="line"><span class="string">begin</span></span><br><span class="line"><span class="string">   return name;</span></span><br><span class="line"><span class="string">end   </span></span><br><span class="line"><span class="string">$body$ language plpgsql ;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--代码6</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc() </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">varchar</span> <span class="keyword">as</span> </span><br><span class="line">$func$</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">   <span class="keyword">name</span> <span class="built_in">varchar</span> := $$wangzhen<span class="string">'blog$$;</span></span><br><span class="line"><span class="string">begin</span></span><br><span class="line"><span class="string">   return name;</span></span><br><span class="line"><span class="string">end   </span></span><br><span class="line"><span class="string">$func$ language plpgsql ;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--代码7</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc() </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">varchar</span> <span class="keyword">as</span> </span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">   <span class="keyword">name</span> <span class="built_in">varchar</span> := <span class="string">'wangzhen''blog'</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">name</span>;</span><br><span class="line"><span class="keyword">end</span>   </span><br><span class="line">$$ <span class="keyword">language</span> plpgsql ;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="代码块"><a class="header-anchor" href="#代码块"></a>代码块</h3>
<ul>
<li>
<p>块名可选，代码8和9等价</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--代码8</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc() </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">varchar</span> <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line">&lt;&lt;outblock&gt;&gt;</span><br><span class="line"><span class="keyword">declare</span> </span><br><span class="line">   <span class="keyword">name</span> <span class="built_in">varchar</span> := <span class="string">'wangzhen'</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">return</span> outblock.name;</span><br><span class="line"><span class="keyword">end</span>;        </span><br><span class="line">$$ language plpgsql;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--代码9</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc() </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">varchar</span> <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span> </span><br><span class="line">   <span class="keyword">name</span> <span class="built_in">varchar</span> := <span class="string">'wangzhen'</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">name</span>;</span><br><span class="line"><span class="keyword">end</span>;        </span><br><span class="line">$$ language plpgsql;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>块可嵌套，内层同名变量覆盖外层同名变量，可通过指定块名引用。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--代码10</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc() </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">varchar</span> <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line">&lt;&lt;outblock&gt;&gt;</span><br><span class="line"><span class="keyword">declare</span> </span><br><span class="line">   <span class="keyword">name</span> <span class="built_in">varchar</span> := <span class="string">'wangzhen'</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   &lt;&lt;innerblock&gt;&gt;</span><br><span class="line">   <span class="keyword">declare</span> </span><br><span class="line">      <span class="keyword">name</span> <span class="built_in">varchar</span> := <span class="string">'xiaozhang'</span>;</span><br><span class="line">   <span class="keyword">begin</span></span><br><span class="line">      outblock.name = innerblock.name;</span><br><span class="line">   <span class="keyword">end</span>;   </span><br><span class="line">   return outblock.name;</span><br><span class="line"><span class="keyword">end</span>;        </span><br><span class="line">$$ language plpgsql;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">abase=# select somefunc();</span><br><span class="line"> somefunc  </span><br><span class="line"><span class="comment">-----------</span></span><br><span class="line"> xiaozhang</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>
<p>函数体是一个隐藏的块，块名是函数名。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--代码11</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc(<span class="keyword">name</span> <span class="built_in">varchar</span>) </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">varchar</span> <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line">&lt;&lt;outblock&gt;&gt;</span><br><span class="line"><span class="keyword">declare</span> </span><br><span class="line">   <span class="keyword">name</span> <span class="built_in">varchar</span> := somefunc.name;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">return</span> outblock.name;</span><br><span class="line"><span class="keyword">end</span>;        </span><br><span class="line">$$ language plpgsql;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">abase=# select somefunc('xiaoli');</span><br><span class="line"> somefunc </span><br><span class="line"><span class="comment">----------</span></span><br><span class="line"> xiaoli</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="命名参数"><a class="header-anchor" href="#命名参数"></a>命名参数</h3>
<ul>
<li>
<p>在函数声明时直接命名参数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--代码12</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc(newname <span class="built_in">varchar</span>) </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">varchar</span> <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span> </span><br><span class="line">   <span class="keyword">name</span> <span class="built_in">varchar</span> := newname;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">name</span>;</span><br><span class="line"><span class="keyword">end</span>;        </span><br><span class="line">$$ language plpgsql;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>
<p>使用别名和美元符号</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--代码13</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc(<span class="built_in">varchar</span>,<span class="built_in">varchar</span>) </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">varchar</span> <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span> </span><br><span class="line">   newname <span class="keyword">alias</span> <span class="keyword">for</span> $<span class="number">1</span>;</span><br><span class="line">   name varchar := newname;</span><br><span class="line">   name2 varchar := $2;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">name</span>;</span><br><span class="line"><span class="keyword">end</span>;        </span><br><span class="line">$$ language plpgsql;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="执行sql"><a class="header-anchor" href="#执行sql"></a>执行sql</h3>
<ul>
<li>
<p>没有返回结果的SQL可以直接执行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--代码14</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc2() </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">void</span> <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">create</span> <span class="keyword">table</span> test1 (n_id <span class="built_in">integer</span>,c_mc <span class="built_in">varchar</span>(<span class="number">300</span>));</span><br><span class="line">   <span class="keyword">insert</span> <span class="keyword">into</span> test1 (n_id,c_mc) <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'wangzhen'</span>);</span><br><span class="line"><span class="keyword">end</span>;        </span><br><span class="line">$$ language plpgsql;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>
<p>不需要返回结果的select可以通过perform执行。perform替换select</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--代码15</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc3() </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">void</span> <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   perform * <span class="keyword">from</span> test1;</span><br><span class="line"><span class="keyword">end</span>;        </span><br><span class="line">$$ language plpgsql;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--代码16</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc3() </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">void</span> <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   perform somefunc();</span><br><span class="line">   <span class="comment">--perform 怎么处理with和其他复杂查询？</span></span><br><span class="line"><span class="keyword">end</span>;        </span><br><span class="line">$$ language plpgsql;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>执行动态拼接SQL</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--代码17</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc3() </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">void</span> <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">var_sql <span class="built_in">varchar</span> := <span class="string">'insert into test1 values (0,'</span>||quote_literal(<span class="string">'admin'</span>)||<span class="string">')'</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">execute</span> var_sql;</span><br><span class="line">   <span class="keyword">execute</span> <span class="keyword">format</span>(<span class="string">'insert into %I values (%L,%L)'</span>,<span class="string">'test1'</span>,<span class="number">2</span>,<span class="string">'xiaoniu'</span>);</span><br><span class="line"><span class="keyword">end</span>;        </span><br><span class="line">$$ language plpgsql;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="返回结果"><a class="header-anchor" href="#返回结果"></a>返回结果</h3>
<blockquote>
<p>返回结果分为返回标量（单行）和返回结果集合（多行）两种情况。</p>
</blockquote>
<ul>
<li>
<p>返回标量</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 代码18</span></span><br><span class="line"><span class="comment">-- 返回单行int</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc4()</span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">int</span> <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line"><span class="keyword">end</span>   </span><br><span class="line">$$ <span class="keyword">language</span> plpgsql;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 代码19</span></span><br><span class="line"><span class="comment">-- 通过out参数返回</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc4(<span class="keyword">out</span> v1 <span class="built_in">integer</span>) </span><br><span class="line"><span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   v1 := <span class="number">100</span>;</span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line">$$ <span class="keyword">language</span> plpgsql;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- OUT 返回</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">FUNCTION</span> <span class="keyword">if</span> <span class="keyword">exists</span> update_products(<span class="built_in">character</span> <span class="built_in">varying</span>,<span class="built_in">character</span> <span class="built_in">varying</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> update_products(main_table_name <span class="built_in">varchar</span>, child_table_name <span class="built_in">varchar</span>, <span class="keyword">OUT</span> <span class="keyword">success</span> <span class="built_in">int</span>, <span class="keyword">OUT</span> <span class="keyword">error</span> <span class="built_in">int</span>) <span class="keyword">returns</span> setof <span class="built_in">record</span> <span class="keyword">as</span></span><br><span class="line">$<span class="keyword">body</span>$</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">  rec_record <span class="built_in">record</span>;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">success</span> := <span class="number">0</span>;</span><br><span class="line">  for rec_record in <span class="keyword">select</span> * <span class="keyword">from</span> loans_category <span class="keyword">loop</span></span><br><span class="line">    <span class="keyword">success</span> := <span class="keyword">success</span> + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line">  return next;</span><br><span class="line">  // r := row(main_table_name, child_table_name);  返回行数据</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"></span><br><span class="line">$body$ language plpgsql;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 代码20</span></span><br><span class="line"><span class="comment">-- 返回单行record 复合类型</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc4(<span class="keyword">id</span> <span class="built_in">integer</span>,mc <span class="built_in">varchar</span>) </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">record</span> <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span> </span><br><span class="line">   r <span class="built_in">record</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   r := <span class="keyword">row</span>(<span class="keyword">id</span>,mc);</span><br><span class="line">   return r;</span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line">$$ <span class="keyword">language</span> plpgsql;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>SETOF 作用</p>
<blockquote>
<p>返回结果集合（多行）时，需要使用SETOF指定</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--代码21</span></span><br><span class="line"><span class="comment">--返回单列多行</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc5()</span><br><span class="line"><span class="keyword">returns</span> setof <span class="built_in">int</span> <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">for</span> <span class="keyword">id</span> <span class="keyword">in</span> <span class="keyword">select</span> n_id <span class="keyword">from</span> test1 </span><br><span class="line">   <span class="keyword">loop</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">next</span> <span class="keyword">id</span>;</span><br><span class="line">   <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line">   return;  </span><br><span class="line"><span class="keyword">end</span>   </span><br><span class="line">$$ <span class="keyword">language</span> plpgsql;</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">abase=# select somefunc5();</span><br><span class="line"> somefunc5 </span><br><span class="line"><span class="comment">-----------</span></span><br><span class="line">         1</span><br><span class="line">         1</span><br><span class="line">         0</span><br><span class="line">         0</span><br><span class="line">         2</span><br><span class="line">(5 rows)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>
<p>返回结果集</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 代码22</span></span><br><span class="line"><span class="comment">-- 通过out参数返回</span></span><br><span class="line"><span class="comment">-- returns setof record  可以省略</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc6(<span class="keyword">out</span> <span class="keyword">id</span> <span class="built_in">integer</span>,<span class="keyword">out</span> <span class="keyword">name</span> <span class="built_in">varchar</span>)</span><br><span class="line"><span class="keyword">returns</span> setof <span class="built_in">record</span> <span class="keyword">as</span> </span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span> </span><br><span class="line">   r <span class="built_in">record</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">for</span> r <span class="keyword">in</span> <span class="keyword">select</span> n_id,c_mc <span class="keyword">from</span> test1 </span><br><span class="line">   <span class="keyword">loop</span></span><br><span class="line">      <span class="keyword">id</span> := r.n_id;</span><br><span class="line">      name := r.c_mc;</span><br><span class="line">      return next;</span><br><span class="line">   <span class="keyword">end</span> <span class="keyword">loop</span>; </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">$$ <span class="keyword">language</span> plpgsql;</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">abase=# select * from somefunc6() ;</span><br><span class="line"> id |   name    </span><br><span class="line"><span class="comment">----+-----------</span></span><br><span class="line">  1 | wangzhen</span><br><span class="line">  1 | xiaozhang</span><br><span class="line">  0 | admin</span><br><span class="line">  0 | admin</span><br><span class="line">  2 | xiaoniu</span><br><span class="line">(5 rows)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 代码23</span></span><br><span class="line"><span class="comment">-- 通过return next 返回自定义类型</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">type</span> test_rs <span class="keyword">as</span> (<span class="keyword">id</span> <span class="built_in">int</span>,mc <span class="built_in">varchar</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc7()</span><br><span class="line"><span class="keyword">returns</span> setof test_rs <span class="keyword">as</span> </span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">   r test_rs%rowtype;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">for</span> r <span class="keyword">in</span> <span class="keyword">select</span> n_id,c_mc <span class="keyword">from</span> test1</span><br><span class="line">   <span class="keyword">loop</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">next</span> r;</span><br><span class="line">   <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line">   return;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">$$ <span class="keyword">language</span> plpgsql;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 代码24</span></span><br><span class="line"><span class="comment">-- 通过return query 返回自定义类型</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc7()</span><br><span class="line"><span class="keyword">returns</span> setof test_rs <span class="keyword">as</span> </span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">   r test_rs%rowtype;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">query</span> <span class="keyword">select</span> n_id,c_mc <span class="keyword">from</span> test1;</span><br><span class="line">   return;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">$$ <span class="keyword">language</span> plpgsql;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 代码25</span></span><br><span class="line"><span class="comment">-- 通过return next返回表类型</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc7()</span><br><span class="line"><span class="keyword">returns</span> setof test1 <span class="keyword">as</span> </span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">   r test1%rowtype;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">for</span> r <span class="keyword">in</span> <span class="keyword">select</span> n_id,c_mc <span class="keyword">from</span> test1</span><br><span class="line">   <span class="keyword">loop</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">next</span> r;</span><br><span class="line">   <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line">   return;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">$$ <span class="keyword">language</span> plpgsql;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 代码26</span></span><br><span class="line"><span class="comment">-- 通过拼接sql  return next 返回自定义类型</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc7()</span><br><span class="line"><span class="keyword">returns</span> setof test_rs <span class="keyword">as</span> </span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">   r test_rs%rowtype;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">for</span> r <span class="keyword">in</span> <span class="keyword">execute</span> <span class="string">'select n_id,c_mc from test1'</span></span><br><span class="line">   <span class="keyword">loop</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">next</span> r;</span><br><span class="line">   <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line">   return;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">$$ <span class="keyword">language</span> plpgsql;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 代码26</span></span><br><span class="line"><span class="comment">-- 通过拼接sql  return query 返回自定义类型</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> somefunc7()</span><br><span class="line"><span class="keyword">returns</span> setof test_rs <span class="keyword">as</span> </span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">   r test_rs%rowtype;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">query</span> <span class="keyword">execute</span> <span class="string">'select n_id,c_mc from test1'</span>;</span><br><span class="line">   return;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">$$ <span class="keyword">language</span> plpgsql;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>返回结果集时PostgreSQL 9.5.4，需要使用自定义类型或表类型制定返回类型，不能用record匿名类型。</p>
</blockquote>
<h3 id="循环判断"><a class="header-anchor" href="#循环判断"></a>循环判断</h3>
<ul>
<li>
<p>LOOP循环</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> testloop1() </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">void</span> <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">    <span class="keyword">count</span> <span class="built_in">int</span> :=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">loop</span></span><br><span class="line">       <span class="keyword">exit</span> <span class="keyword">when</span> <span class="keyword">count</span> &gt;=<span class="number">100</span>;</span><br><span class="line">       count := count + 1;</span><br><span class="line">       raise notice 'count is %',count;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">$$ <span class="keyword">language</span> plpgsql ;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>WHILE循环</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> testloop2() </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">void</span> <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">    <span class="keyword">count</span> <span class="built_in">int</span> :=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">count</span> &lt;<span class="number">100</span> <span class="keyword">loop</span></span><br><span class="line">       <span class="keyword">count</span> := <span class="keyword">count</span> + <span class="number">1</span>;</span><br><span class="line">       raise notice 'count is %',count;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">$$ <span class="keyword">language</span> plpgsql ;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>FOR循环</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> testloop3() </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">void</span> <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.100</span> <span class="keyword">loop</span></span><br><span class="line">     <span class="keyword">raise</span> <span class="keyword">notice</span> <span class="string">'count is %'</span>,i;</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">$$ <span class="keyword">language</span> plpgsql;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> testloop4() </span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">void</span> <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">reverse</span> <span class="number">100.</span><span class="number">.1</span> <span class="keyword">by</span> <span class="number">2</span> <span class="keyword">loop</span> </span><br><span class="line">     <span class="keyword">raise</span> <span class="keyword">notice</span> <span class="string">'count is %'</span>,i;</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">$$ <span class="keyword">language</span> plpgsql;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>FOREACH循环</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> testloop5()</span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">void</span> <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">  v_arr <span class="built_in">int</span>[]:= <span class="built_in">array</span>[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];</span><br><span class="line">  i int;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  foreach i <span class="keyword">in</span> <span class="built_in">array</span> v_arr <span class="keyword">loop</span></span><br><span class="line">      <span class="keyword">raise</span> <span class="keyword">notice</span> <span class="string">'count is %'</span>,i;</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">$$ <span class="keyword">language</span> plpgsql;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="参考资料"><a class="header-anchor" href="#参考资料"></a>参考资料</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">-- record/%ROWTYPE类型返回</span><br><span class="line">-- 返回结果集合（多行）时，需要使用SETOF指定. </span><br><span class="line">-- returns record || returns setof record</span><br><span class="line"></span><br><span class="line">DROP FUNCTION if exists update_products(character varying,character varying);</span><br><span class="line">create or replace function update_products(main_table_name varchar, child_table_name varchar) returns setof record as</span><br><span class="line">$body$</span><br><span class="line">declare</span><br><span class="line">  rec_row loans_category%rowtype;</span><br><span class="line">  rec_record record;</span><br><span class="line">BEGIN</span><br><span class="line">  for rec_row in select * from loans_category loop</span><br><span class="line">    return next rec_row;</span><br><span class="line">  end loop;</span><br><span class="line">  for rec_record in select * from loans_category loop</span><br><span class="line">    return next rec_record;</span><br><span class="line">  end loop;</span><br><span class="line">  return next;</span><br><span class="line">END;</span><br><span class="line">$body$ language plpgsql;</span><br><span class="line"></span><br><span class="line">select * from update_products();</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">to_char(timestamp, text)	text	把时间戳转换成字串  to_char(current_timestamp, &apos;HH12:MI:SS&apos;)</span><br><span class="line">to_char(interval, text)	text	把时间间隔转为字串  to_char(interval &apos;15h 2m 12s&apos;, &apos;HH24:MI:SS&apos;)</span><br><span class="line">to_char(int, text)	text	把整数转换成字串  to_char(125, &apos;999&apos;)</span><br><span class="line">to_char(double precision, text)	text	把实数/双精度数转换成字串  to_char(125.8::real, &apos;999D9&apos;)</span><br><span class="line">to_char(numeric, text)	text	把 numeric 转换成字串  to_char(-125.8, &apos;999D99S&apos;)</span><br><span class="line">to_date(text, text)	date	把字串转换成日期  to_date(&apos;05 Dec 2000&apos;, &apos;DD Mon YYYY&apos;)</span><br><span class="line">to_timestamp(text, text)	timestamp with time zone  把字串转换成时间戳  to_timestamp(&apos;05 Dec 2000&apos;, &apos;DD Mon YYYY&apos;)</span><br><span class="line">to_timestamp(double precision)	timestamp with time zone  把 UNIX 纪元转换成时间戳	to_timestamp(200120400)</span><br><span class="line">to_number(text, text)	numeric	把字串转换成 numeric  to_number(&apos;12,454.8-&apos;, &apos;99G999D9S&apos;)</span><br></pre></td></tr></table></figure>
<ol>
<li>decode 用 case when a=1 then b else c end</li>
<li>最后一天  to_date(? +‘1 mons’::interval,‘yyyy-mm’) -1</li>
<li>第一天 to_date(?,‘yyyy-mm’) , date_trunc(‘month’,?)</li>
<li>字段别名 加上 as</li>
<li>子查询一定要用别名</li>
<li>取子树 ,postgresql需人自己写函数，或者用一些有结构特性字段如1.1,1.1.1,1.1.2  来代替</li>
<li>trunc(im.createdate) 可改为date_trunc(‘day’,createdate) ，date_trunc 与oracle的trunc很像,还可以<br>
<code>SELECT date_trunc('hour', TIMESTAMP '2001-02-16 20:38:40'); Result: 2001-02-16 20:00:00+00</code><br>
<code>SELECT date_trunc('year', TIMESTAMP '2001-02-16 20:38:40'); Result: 2001-01-01 00:00:00+00</code></li>
<li>postgres-当日, 带时分秒,now()  oracle- sysdate</li>
<li>postgres-当日,不带时分秒current_date,oracle  to_char(sysdate,'YYYY-MM-DD)</li>
<li>nvl 全部替换成 coalesce  如 coalesce(im.invoiceamount,0)</li>
<li>小数据位数round,例保留一位小数 用select round(2.16,1)  Result: 2.2 会四舍五入</li>
<li>转志数据类型用::数据类型,如to_number() 改用::numeric</li>
<li>如果取子树,不包含自身,使用函数时,第二个参数取2,如,getorgantree(?,2)</li>
<li>项目树函数第一个参数是id,其他的如果地区编码,税务机关分别有参数为编码的,如get…tree(code,level),参数为id的,如get…treebyid(id,level)</li>
<li>修改表时,表名不能带别名,如update taxpayer_cognizance_invoice tc   这里taxpayer_cognizance_invoice 不能带别名tc</li>
</ol>
<p>资料链接：<br>
<a href="http://www.postgres.cn/docs/9.4/plpgsql-control-structures.html#PLPGSQL-ERROR-TRAPPING" target="_blank" rel="noopener">PL/pgSQL 控制结构</a></p>

        
    </section>
</article>



<div class="comments">
    <div id="comments"></div>
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
    new Gitalk({
        clientID: "6f5e8f287e18d0fe8720",
        clientSecret: "d951a19150cabd06c9e4fb2d72f0dc25132d0999",
        repo: "abcdkyd.github.io",
        owner: "abcdkyd",
        admin: ["abcdkyd"],
        id: "2018/06/15/postgres编写存储过程",
        distractionFreeMode: true,
        title: "PostgreSQL pl/pgsql 编写存储过程",
        body: "https://abcdkyd.github.io/2018/06/15/postgres编写存储过程/",
        labels: ["PostgreSQL","存储过程"]
    }).render('comments');
    </script>
</div>

</div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>

    
</footer>

    </main>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }
            
            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle();
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp();
            }, 3000);
        }
    });
    </script>
    
        <script type="text/javascript" src="/js/scrollspy.min.js"></script>
        <script type="text/javascript">
        $(document.body).scrollspy({target: '#aside-inner'});
        </script>
    

</body>
</html>
